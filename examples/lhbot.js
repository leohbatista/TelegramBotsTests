const TeleBot = require('../');
const bot = new TeleBot({
    token:'410634008:AAHeCljq1fdI4ZRHvkB4MUGx3mQ-Yz8qCIc',
    usePlugins: ['askUser']
});

photoUrl = "https://drive.google.com/open?id=0B2kSTkTZoo99RVlZbklELXFId2s";

bot.on('/time', msg => {

    return bot.sendMessage(msg.from.id, 'Getting time...').then(re => {
        // Start updating message
        updateTime(msg.from.id, re.result.message_id);
    });

});

function updateTime(chatId, messageId) {

    // Update every second
    setInterval(() => {
        bot.editMessageText(
            {chatId, messageId}, `<b>Current time:</b> ${ time() }`,
            {parseMode: 'html'}
        ).catch(error => console.log('Error:', error));
    }, 1000);

}

// Griaule Command
bot.on('/griaule', msg => {
    //bot.sendMessage(msg.from.id, 'Big Data Pergolados');
    return bot.sendPhoto(
        msg.from.id, photoUrl, {caption: 'Big Data Pergolados'}
    )
});

// Horários Circular UNICAMP
bot.on('/circular', msg => {
    
        let replyMarkup = bot.inlineKeyboard([
            [
                bot.inlineButton("Circular 1",{url: 'http://www.prefeitura.unicamp.br/documentos/HORARIO%20CIRCULAR%20I'})
            ],
            [
                bot.inlineButton("Circular 2",{url: 'http://www.prefeitura.unicamp.br/documentos/HORARIO%20CIRCULAR%20II'})
            ],
            [
                bot.inlineButton("Circular Noturno",{url: 'http://www.prefeitura.unicamp.br/documentos/HORARIO%20CIRCULAR%20NOTURNO'})
            ],
        ]);
    
        return bot.sendMessage(msg.from.id, 'Qual circular?', {replyMarkup});
});

bot.on('/circular1', msg => {    
    return bot.sendMessage(msg.from.id,
         "Qual o ponto?\n".concat(
         "1 - PONTO INICIAL (HEMOCENTRO)\n", 
         "2 - CRECHE FCM\n",
         "3 - CAISM\n",
         "4 - PORTARIA HC\n",
         "5 - CEMEQ / BB\n",
         "6 - CEMIB\n",
         "7 - MEIO AMBIENTE\n",
         "8 - EDITORA / LABEURB\n",
         "9 - CBMEG\n",
         "10 - FEAGRI\n",
         "11 - EMBRAPA\n",
         "12 - CCUEC\n",
         "13 - FEM - OFICINA\n",
         "14 - FEM / GCA\n",
         "15 - FE / IFGW\n",
         "16 - IE / IMECC\n",
         "17 - ADUNICAMP\n",
         "18 - FUNCAMP\n",
         "19 - CASA DO LAGO\n",
         "20 - FEF / CDC\n",
         "21 - FEF / RU\n",
         "22 - STAR CLEAN\n",
         "23 - IB / PASTEL\n",
         "24 - REITORIA\n",
         "25 - SOBRAPAR\n",
         "26 - CAISM\n",
         "27 - FCM / CEPRE\n",
         "28 - PTO FINAL\n"),
         {ask: 'ponto1'}); 
});    

bot.on('ask.ponto1', msg => {
    
        const id = msg.from.id;
        const ponto = Number(msg.text);
        
        if (!ponto || ponto > 28 || ponto < 1) {
            return bot.sendMessage(id, 'Ponto inválido, digite novamente', {ask: 'ponto1'});
        } else {
            prox = getNextCircular1(ponto-1);
            if(prox) {
                return bot.sendMessage(id, 'Próximo ônibus: '+prox);
            } else {
                return bot.sendMessage(id, 'Próximo ônibus: só amanhã');
            }
            
        }
    });

bot.start();

// Get current time
function time() {
    return new Date().toTimeString().replace(/.*(\d{2}:\d{2}:\d{2}).*/, '$1');
}


function getNextCircular1(ponto) {
    const horarios = [["6:30", "6:31", "6:33", "6:34", "6:35", "6:36", "6:37", "6:37", "6:38", "6:39", "6:39", "6:40", "6:41", "6:41", "6:42", "6:42", "6:43", "6:43", "6:44", "6:45", "6:46", "6:47", "6:48", "6:49", "6:50", "6:51", "6:54", "6:55"],
    ["7:00", "7:01", "7:03", "7:04", "7:05", "7:07", "7:07", "7:07", "7:09", "7:09", "7:10", "7:10", "7:11", "7:11", "7:12", "7:12", "7:13", "7:14", "7:14", "7:15", "7:16", "7:18", "7:19", "7:20", "7:21", "7:23", "7:24", "7:25"],
    ["7:20", "7:21", "7:23", "7:24", "7:25", "7:27", "7:27", "7:27", "7:29", "7:29", "7:30", "7:30", "7:31", "7:31", "7:32", "7:32", "7:33", "7:34", "7:34", "7:35", "7:36", "7:38", "7:39", "7:40", "7:41", "7:43", "7:44", "7:45"],
    ["7:35", "7:36", "7:38", "7:39", "7:40", "7:41", "7:42", "7:42", "7:44", "7:44", "7:45", "7:46", "7:46", "7:47", "7:47", "7:47", "7:48", "7:49", "7:49", "7:50", "7:51", "7:52", "7:53", "7:54", "7:55", "7:57", "7:59", "8:00"],
    ["7:55", "7:56", "7:59", "8:00", "8:00", "8:03", "8:03", "8:03", "8:05", "8:05", "8:06", "8:06", "8:08", "8:08", "8:09", "8:09", "8:10", "8:11", "8:12", "8:13", "8:13", "8:15", "8:15", "8:17", "8:18", "8:21", "8:22", "8:23"],
    ["8:15", "8:16", "8:19", "8:20", "8:21", "8:23", "8:24", "8:24", "8:25", "8:26", "8:27", "8:28", "8:29", "8:29", "8:30", "8:30", "8:31", "8:31", "8:32", "8:32", "8:33", "8:34", "8:35", "8:37", "8:38", "8:39", "8:41", "8:43"],
    ["8:35", "8:36", "8:39", "8:40", "8:40", "8:42", "8:43", "8:43", "8:44", "8:45", "8:45", "8:46", "8:47", "8:48", "8:49", "8:49", "8:50", "8:50", "8:51", "8:52", "8:54", "8:56", "8:56", "8:57", "8:58", "9:00", "9:02", "9:03"],
    ["8:55", "8:56", "8:59", "9:00", "9:01", "9:03", "9:03", "9:04", "9:05", "9:06", "9:07", "9:07", "9:08", "9:08", "9:09", "9:09", "9:11", "9:11", "9:12", "9:12", "9:13", "9:15", "9:16", "9:17", "9:19", "9:20", "9:22", "9:23"],
    ["9:15", "9:15", "9:17", "9:19", "9:20", "9:20", "9:21", "9:21", "9:22", "9:23", "9:23", "9:24", "9:25", "9:25", "9:25", "9:26", "9:27", "9:28", "9:28", "9:29", "9:30", "9:31", "9:31", "9:33", "9:34", "9:36", "9:37", "9:38"],
    ["9:35", "9:36", "9:38", "9:39", "9:41", "9:42", "9:42", "9:43", "9:44", "9:44", "9:45", "9:46", "9:47", "9:47", "9:48", "9:48", "9:49", "9:50", "9:51", "9:52", "9:53", "9:54", "9:55", "9:56", "9:58", "9:59", "10:00", "10:02"],
    ["9:55", "9:56", "9:59", "10:00", "10:01", "10:03", "10:03", "10:04", "10:05", "10:05", "10:06", "10:06", "10:07", "10:08", "10:09", "10:10", "10:10", "10:11", "10:12", "10:13", "10:14", "10:15", "10:16", "10:17", "10:19", "10:19", "10:21", "10:22"],
    ["10:15", "10:16", "10:19", "10:20", "10:21", "10:23", "10:23", "10:24", "10:25", "10:26", "10:26", "10:27", "10:28", "10:28", "10:29", "10:30", "10:31", "10:32", "10:33", "10:33", "10:35", "10:35", "10:37", "10:39", "10:40", "10:41", "10:42", "10:43"],
    ["10:35", "10:36", "10:37", "10:38", "10:39", "10:41", "10:41", "10:42", "10:43", "10:43", "10:44", "10:44", "10:45", "10:45", "10:48", "10:49", "10:50", "10:51", "10:52", "10:53", "10:54", "10:56", "10:56", "10:59", "11:00", "11:01", "11:03", "11:03"],
    ["10:55", "10:56", "10:57", "10:58", "10:59", "11:01", "11:01", "11:02", "11:03", "11:03", "11:04", "11:04", "11:05", "11:05", "11:06", "11:07", "11:08", "11:09", "11:09", "11:10", "11:11", "11:13", "11:13", "11:15", "11:16", "11:19", "11:20", "11:20"],
    ["11:15", "11:16", "11:18", "11:19", "11:21", "11:22", "11:22", "11:23", "11:24", "11:25", "11:25", "11:27", "11:28", "11:28", "11:28", "11:29", "11:30", "11:31", "11:32", "11:33", "11:34", "11:35", "11:36", "11:38", "11:39", "11:41", "11:42", "11:42"],
    ["11:35", "11:36", "11:37", "11:39", "11:40", "11:41", "11:41", "11:42", "11:43", "11:44", "11:44", "11:45", "11:46", "11:46", "11:47", "11:48", "11:49", "11:50", "11:51", "11:52", "11:53", "11:54", "11:55", "11:57", "11:59", "12:00", "12:01", "12:01"],
    ["11:55", "11:55", "11:57", "11:58", "11:59", "12:01", "12:02", "12:02", "12:04", "12:05", "12:05", "12:06", "12:07", "12:07", "12:08", "12:09", "12:10", "12:11", "12:12", "12:13", "12:14", "12:16", "12:16", "12:18", "12:20", "12:23", "12:24", "12:24"],
    ["12:15", "12:16", "12:19", "12:20", "12:21", "12:23", "12:24", "12:24", "12:26", "12:27", "12:27", "12:28", "12:29", "12:29", "12:30", "12:30", "12:31", "12:31", "12:32", "12:33", "12:34", "12:35", "12:36", "12:38", "12:40", "12:41", "12:43", "12:45"],
    ["12:35", "12:35", "12:37", "12:39", "12:40", "12:41", "12:41", "12:42", "12:44", "12:46", "12:47", "12:47", "12:49", "12:49", "12:50", "12:51", "12:52", "12:53", "12:54", "12:55", "12:56", "12:59", "12:59", "13:02", "13:04", "13:08", "13:09", "13:09"],
    ["12:55", "12:56", "12:58", "12:59", "13:00", "13:02", "13:02", "13:03", "13:04", "13:05", "13:05", "13:06", "13:07", "13:07", "13:08", "13:09", "13:10", "13:11", "13:11", "13:12", "13:14", "13:16", "13:17", "13:20", "13:21", "13:22", "13:24", "13:25"],
    ["13:15", "13:15", "13:17", "13:19", "13:20", "13:21", "13:22", "13:23", "13:24", "13:25", "13:26", "13:27", "13:28", "13:28", "13:29", "13:29", "13:30", "13:31", "13:32", "13:33", "13:34", "13:35", "13:37", "13:39", "13:40", "13:43", "13:45", "13:45"],
    ["13:35", "13:36", "13:39", "13:41", "13:43", "13:44", "13:44", "13:45", "13:46", "13:47", "13:48", "13:48", "13:49", "13:49", "13:50", "13:51", "13:52", "13:53", "13:54", "13:55", "13:56", "13:58", "13:59", "14:00", "14:01", "14:04", "14:05", "14:05"],
    ["13:55", "13:55", "13:57", "13:58", "13:59", "14:01", "14:01", "14:02", "14:04", "14:05", "14:05", "14:06", "14:07", "14:07", "14:08", "14:09", "14:10", "14:11", "14:12", "14:13", "14:15", "14:16", "14:17", "14:19", "14:20", "14:23", "14:24", "14:24"],
    ["14:15", "14:15", "14:17", "14:19", "14:20", "14:21", "14:22", "14:24", "14:25", "14:25", "14:26", "14:26", "14:27", "14:27", "14:28", "14:28", "14:29", "14:30", "14:30", "14:31", "14:32", "14:33", "14:34", "14:35", "14:36", "14:38", "14:39", "14:40"],
    ["14:25", "14:26", "14:27", "14:28", "14:29", "14:31", "14:31", "14:32", "14:33", "14:34", "14:35", "14:35", "14:36", "14:36", "14:37", "14:38", "14:39", "14:40", "14:41", "14:42", "14:43", "14:44", "14:45", "14:46", "14:48", "14:51", "14:52", "14:52"],
    ["14:55", "14:56", "14:57", "14:58", "14:59", "15:00", "15:00", "15:01", "15:03", "15:04", "15:04", "15:05", "15:06", "15:06", "15:07", "15:08", "15:09", "15:10", "15:10", "15:12", "15:13", "15:14", "15:14", "15:17", "15:19", "15:20", "15:21", "15:22"],
    ["15:15", "15:15", "15:17", "15:18", "15:19", "15:20", "15:20", "15:21", "15:22", "15:23", "15:24", "15:24", "15:25", "15:25", "15:26", "15:27", "15:28", "15:29", "15:29", "15:30", "15:31", "15:33", "15:34", "15:35", "15:37", "15:39", "15:40", "15:40"],
    ["15:35", "15:36", "15:37", "15:39", "15:40", "15:41", "15:41", "15:42", "15:43", "15:44", "15:45", "15:45", "15:46", "15:46", "15:47", "15:48", "15:48", "15:49", "15:49", "15:50", "15:51", "15:52", "15:52", "15:54", "15:55", "15:58", "15:59", "15:59"],
    ["15:55", "15:56", "15:57", "15:58", "15:59", "16:01", "16:01", "16:02", "16:03", "16:04", "16:05", "16:05", "16:06", "16:06", "16:07", "16:08", "16:09", "16:10", "16:10", "16:11", "16:12", "16:13", "16:13", "16:15", "16:16", "16:19", "16:20", "16:20"],
    ["16:05", "16:06", "16:07", "16:08", "16:08", "16:10", "16:10", "16:11", "16:12", "16:13", "16:13", "16:14", "16:15", "16:15", "16:16", "16:17", "16:18", "16:18", "16:19", "16:20", "16:21", "16:22", "16:22", "16:23", "16:24", "16:27", "16:28", "16:30"],
    ["16:25", "16:26", "16:27", "16:28", "16:29", "16:30", "16:31", "16:31", "16:32", "16:32", "16:33", "16:33", "16:34", "16:34", "16:35", "16:36", "16:37", "16:37", "16:38", "16:39", "16:40", "16:41", "16:42", "16:42", "16:43", "16:45", "16:46", "16:46"],
    ["16:50", "16:51", "16:52", "16:53", "16:54", "16:55", "16:56", "16:57", "16:58", "16:58", "16:59", "16:59", "17:00", "17:00", "17:01", "17:02", "17:03", "17:03", "17:04", "17:05", "17:06", "17:07", "17:07", "17:08", "17:10", "17:15", "17:17", "17:17"],
    ["17:15", "17:15", "17:17", "17:19", "17:20", "17:21", "17:23", "17:23", "17:25", "17:26", "17:27", "17:27", "17:29", "17:29", "17:30", "17:31", "17:32", "17:33", "17:31", "17:32", "17:32", "17:34", "17:34", "17:36", "17:37", "17:44", "17:45", "17:45"],
    ["17:35", "17:36", "17:37", "17:39", "17:40", "17:41", "17:41", "17:42", "17:44", "17:45", "17:46", "17:46", "17:48", "17:48", "17:49", "17:50", "17:50", "17:51", "17:51", "17:52", "17:52", "17:53", "17:54", "17:57", "17:58", "17:59", "18:01", "18:02"],
    ["17:55", "17:56", "17:56", "17:58", "17:59", "18:00", "18:00", "18:01", "18:02", "18:03", "18:03", "18:04", "18:05", "18:05", "18;06", "18:07", "18:08", "18:08", "18:09", "18:09", "18:10", "18:11", "18:11", "18:12", "18:13", "18:17", "18:18", "18:18"],
    ["18:10", "18:10", "18:11", "18:12", "18:13", "18:14", "18:14", "18:15", "18:16", "18:17", "18:17", "18:18", "18:19", "18:19", "18;20", "18:21", "18:22", "18:22", "18:23", "18:23", "18:24", "18:24", "18:25", "18:26", "18;27", "18:29", "18:30", "18:30"],
    ["18:25", "18:25", "18:26", "18:26", "18:26", "18:27", "18:27", "18:28", "18:29", "18:30", "18:30", "18:31", "18:32", "18:32", "18;33", "18:33", "18:34", "18:34", "18:35", "18:35", "18:36", "18:36", "18:37", "18:37", "18:38", "18:39", "18:40", "18:40"],
    ["18:40", "18:41", "18:41", "18:42", "18:42", "18:43", "18:43", "18:44", "18:45", "18:46", "18:46", "18:47", "18:48", "18:48", "18:49", "18:49", "18:49", "18:50", "18:50", "18:51", "18:51", "18:52", "18:52", "18:53", "18:53", "18:55", "18:56", "18:56"],
    ["18:50", "18:50", "18:51", "18:52", "18:52", "18:53", "18:53", "18:54", "18:55", "18:56", "18:56", "18:57", "18:58", "18:58", "18:59", "19:00", "19:01", "19:01", "19:02", "19:02", "19:03", "19:03", "19:04", "19:05", "19:05", "19:07", "19:08", "19:08"],
    ["19:20", "19:20", "19:21", "19:22", "19:23", "19:24", "19:24", "19:25", "19:26", "19:26", "19:27", "19:27", "19:28", "19:28", "19:29", "19:30", "19:31", "19:31", "19:31", "19:32", "19:32", "19:33", "19:33", "19:34", "19:34", "19:37", "19:38", "19:38"]];

    var now = new Date();
    var nowTime = [now.getHours(),now.getMinutes()];

    for (var i = 0; i < horarios.length; i++) {
        onibus = horarios[i][ponto];

        hOnibus = Number(onibus.substring(0,onibus.indexOf(":")));
        mOnibus = Number(onibus.substring(onibus.indexOf(":")+1));

        if(hOnibus == nowTime[0] && mOnibus > nowTime[1]) {
            return hOnibus + ":" + mOnibus;
        } else if (hOnibus > nowTime[0]) {
            return hOnibus + ":" + mOnibus;
        }
    }
    return null;
}